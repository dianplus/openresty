name: Merge Multi-Arch Manifests

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to merge (without architecture suffix, e.g., "latest" or "v1.0.0")'
        required: true
        default: 'latest'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: dianplus/openresty

jobs:
  merge:
    name: Merge Manifests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          # 获取基础标签（从输入或使用 latest）
          BASE_TAG="${{ github.event.inputs.tag || 'latest' }}"
          
          # 构建完整镜像名称
          IMAGE="${REGISTRY}/${IMAGE_NAME}:${BASE_TAG}"
          IMAGE_AMD64="${REGISTRY}/${IMAGE_NAME}:${BASE_TAG}-amd64"
          IMAGE_ARM64="${REGISTRY}/${IMAGE_NAME}:${BASE_TAG}-arm64"
          
          echo "Merging manifests:"
          echo "  Base: ${IMAGE}"
          echo "  AMD64: ${IMAGE_AMD64}"
          echo "  ARM64: ${IMAGE_ARM64}"
          
          # 检查架构特定镜像是否存在
          echo "Checking if architecture-specific images exist..."
          if ! docker manifest inspect "${IMAGE_AMD64}" > /dev/null 2>&1; then
            echo "Error: AMD64 image ${IMAGE_AMD64} not found"
            echo "Please ensure the AMD64 build workflow has completed successfully"
            exit 1
          fi
          echo "✓ AMD64 image found: ${IMAGE_AMD64}"
          
          if ! docker manifest inspect "${IMAGE_ARM64}" > /dev/null 2>&1; then
            echo "Error: ARM64 image ${IMAGE_ARM64} not found"
            echo "Please ensure the ARM64 build workflow has completed successfully"
            exit 1
          fi
          echo "✓ ARM64 image found: ${IMAGE_ARM64}"
          
          # 创建并推送多架构 manifest
          echo "Creating multi-arch manifest..."
          docker buildx imagetools create \
            --tag "${IMAGE}" \
            "${IMAGE_AMD64}" \
            "${IMAGE_ARM64}"
          
          echo "✓ Multi-arch manifest created and pushed: ${IMAGE}"
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}

